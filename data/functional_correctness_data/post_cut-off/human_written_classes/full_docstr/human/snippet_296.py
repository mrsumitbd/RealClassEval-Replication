import os
import datetime
from pathlib import Path
import webbrowser
import json

class BenchmarkVisualizer:
    """Utility for visualizing benchmark results and agent interactions across multiple problems"""

    def __init__(self, output_dir=None):
        """
        Initialize the benchmark visualizer.

        Args:
            output_dir: Directory to save visualization HTML files
        """
        self.output_dir = Path(output_dir or 'results/visualizations/html')
        self.output_dir.mkdir(parents=True, exist_ok=True)
        self.mas_visualizer = MASVisualizer(output_dir)

    def generate_summary_html(self, summary_data, results_data, problem_visualizations=None, title=None):
        """
        Generate HTML for visualizing benchmark summary with links to problem visualizations.

        Args:
            summary_data: Dictionary with benchmark summary data
            results_data: List of problem results data
            problem_visualizations: Optional dictionary mapping problem_id to visualization file paths
            title: Optional title for the visualization

        Returns:
            HTML string
        """
        if not summary_data:
            return '<html><body><h1>No benchmark summary data available</h1></body></html>'
        benchmark_name = summary_data.get('benchmark', 'unknown')
        agent_system = summary_data.get('agent_system', 'unknown')
        title = title or f'Benchmark Results - {agent_system} - {benchmark_name}'
        accuracy = summary_data.get('accuracy', 0) * 100
        total_problems = summary_data.get('total_problems', 0)
        correct = summary_data.get('correct', 0)
        total_duration_ms = summary_data.get('total_duration_ms', 0)
        avg_duration_ms = summary_data.get('avg_duration_ms', 0)
        total_tokens = sum((result.get('llm_usage', {}).get('total_tokens', 0) for result in results_data))
        avg_tokens = total_tokens / total_problems if total_problems > 0 else 0
        problem_links = {}
        if problem_visualizations:
            for problem_id, viz_path in problem_visualizations.items():
                if os.path.exists(viz_path):
                    problem_links[problem_id] = os.path.relpath(viz_path, self.output_dir)
        results_json = json.dumps(results_data)
        problem_links_json = json.dumps(problem_links)
        now = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        html = '<!DOCTYPE html>\n<html>\n<head>\n    <meta charset="utf-8">\n    <title>{title}</title>\n    <!-- Google Fonts -->\n    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">\n    <!-- MathJax for LaTeX support -->\n    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>\n    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>\n    <!-- Chart.js for visualizations -->\n    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>\n    <style>\n        :root {{\n            --primary-color: #4a6ee0;\n            --primary-light: rgba(74, 110, 224, 0.1);\n            --secondary-color: #6c757d;\n            --success-color: #28a745;\n            --info-color: #17a2b8;\n            --warning-color: #ffc107;\n            --danger-color: #dc3545;\n            --error-color: #ff6b6b;\n            --light-color: #f8f9fa;\n            --dark-color: #343a40;\n            --border-radius: 8px;\n            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n            --transition: all 0.3s ease;\n        }}\n        \n        * {{\n            box-sizing: border-box;\n            margin: 0;\n            padding: 0;\n        }}\n        \n        body {{\n            font-family: Arial, sans-serif;\n            margin: 0;\n            padding: 0;\n            background-color: #f5f5f5;\n            color: #333;\n            --border-radius: 8px;\n            --box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);\n            height: 100vh;\n            overflow-y: auto;\n        }}\n        \n        .container {{\n            display: flex;\n            flex-direction: column;\n            height: 100vh;\n            max-height: 100vh;\n            padding: 20px;\n            max-width: 1400px;\n            margin: 0 auto;\n            overflow: hidden;\n        }}\n        \n        .header {{\n            background-color: white;\n            border-radius: var(--border-radius);\n            padding: 20px;\n            margin-bottom: 20px;\n            box-shadow: var(--box-shadow);\n            flex-shrink: 0;\n        }}\n        \n        .header h1 {{\n            color: var(--primary-color);\n            font-size: 24px;\n            margin-bottom: 10px;\n        }}\n        \n        .header p {{\n            color: var(--secondary-color);\n            font-size: 14px;\n        }}\n        \n        .summary-stats {{\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));\n            gap: 20px;\n            margin-bottom: 20px;\n        }}\n        \n        .stat-card {{\n            background-color: white;\n            border-radius: var(--border-radius);\n            box-shadow: var(--box-shadow);\n            padding: 20px;\n            display: flex;\n            flex-direction: column;\n        }}\n        \n        .stat-card .stat-title {{\n            font-size: 14px;\n            color: var(--secondary-color);\n            margin-bottom: 10px;\n        }}\n        \n        .stat-card .stat-value {{\n            font-size: 24px;\n            font-weight: 500;\n            color: var(--primary-color);\n            margin-bottom: 5px;\n        }}\n        \n        .stat-card .stat-subtitle {{\n            font-size: 12px;\n            color: var(--secondary-color);\n        }}\n        \n        .charts {{\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));\n            gap: 20px;\n            margin-bottom: 20px;\n            height: 400px;\n            max-height: 400px;\n            overflow: hidden;\n        }}\n        \n        .chart-container {{\n            background-color: white;\n            border-radius: var(--border-radius);\n            box-shadow: var(--box-shadow);\n            padding: 20px;\n            height: 360px;\n            overflow: hidden;\n        }}\n        \n        .chart-title {{\n            font-size: 16px;\n            font-weight: 500;\n            margin-bottom: 15px;\n            color: var(--dark-color);\n        }}\n        \n        .problems-list {{\n            background-color: white;\n            border-radius: var(--border-radius);\n            box-shadow: var(--box-shadow);\n            padding: 20px;\n            margin-bottom: 20px;\n            height: calc(100vh - 640px);\n            max-height: calc(100vh - 640px);\n            overflow-y: auto;\n            min-height: 200px;\n        }}\n        \n        .problems-list h2 {{\n            font-size: 18px;\n            font-weight: 500;\n            margin-bottom: 15px;\n            color: var(--dark-color);\n        }}\n        \n        .problem-card {{\n            border: 1px solid #eee;\n            border-radius: var(--border-radius);\n            padding: 15px;\n            margin-bottom: 15px;\n            transition: var(--transition);\n            background-color: var(--light-color);\n        }}\n        \n        .problem-card:hover {{\n            box-shadow: var(--box-shadow);\n        }}\n        \n        .problem-card.correct {{\n            border-left: 4px solid var(--success-color);\n        }}\n        \n        .problem-card.incorrect {{\n            border-left: 4px solid var(--danger-color);\n        }}\n        \n        .problem-card.errored {{\n            border-left: 4px solid var(--error-color);\n        }}\n        \n        .problem-header {{\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-bottom: 10px;\n        }}\n        \n        .problem-id {{\n            font-weight: 500;\n            font-size: 16px;\n        }}\n        \n        .problem-metrics {{\n            display: flex;\n            gap: 10px;\n            font-size: 13px;\n            color: var(--secondary-color);\n        }}\n        \n        .problem-metric {{\n            display: flex;\n            align-items: center;\n            gap: 5px;\n        }}\n        \n        .problem-content {{\n            margin-bottom: 15px;\n            padding: 10px;\n            background-color: white;\n            border-radius: var(--border-radius);\n        }}\n        \n        .problem-solution {{\n            margin-top: 10px;\n            padding: 10px;\n            background-color: var(--primary-light);\n            border-radius: var(--border-radius);\n        }}\n        \n        .problem-footer {{\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-top: 15px;\n        }}\n        \n        .view-details {{\n            padding: 6px 12px;\n            border: none;\n            background-color: var(--primary-color);\n            color: white;\n            border-radius: var(--border-radius);\n            cursor: pointer;\n            font-weight: 500;\n            font-size: 14px;\n            transition: var(--transition);\n            text-decoration: none;\n            display: inline-block;\n        }}\n        \n        .view-details:hover {{\n            background-color: #3a5ad1;\n            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);\n        }}\n        \n        .badge {{\n            padding: 4px 8px;\n            border-radius: 12px;\n            font-size: 12px;\n            font-weight: 500;\n        }}\n        \n        .badge-success {{\n            background-color: var(--success-color);\n            color: white;\n        }}\n        \n        .badge-danger {{\n            background-color: var(--danger-color);\n            color: white;\n        }}\n\n        .badge-errored {{\n            background-color: var(--error-color);\n            color: white;\n        }}\n        \n        .footer {{\n            margin-top: auto;\n            text-align: center;\n            padding: 20px;\n            color: var(--secondary-color);\n            font-size: 12px;\n        }}\n        \n        /* Expand/collapse problem details */\n        .problem-details {{\n            display: none;\n            margin-top: 15px;\n        }}\n        \n        .problem-card.expanded .problem-details {{\n            display: block;\n        }}\n\n        .toggle-details {{\n            background: none;\n            border: none;\n            cursor: pointer;\n            color: var(--primary-color);\n            font-size: 14px;\n            display: flex;\n            align-items: center;\n            gap: 5px;\n        }}\n        \n        @media screen and (max-width: 768px) {{\n            .summary-stats,\n            .charts {{\n                grid-template-columns: 1fr;\n            }}\n        }}\n    </style>\n</head>\n<body>\n    <div class="container">\n        <div class="header">\n            <h1>{title}</h1>\n            <p>Agent System: {agent_system} | Benchmark: {benchmark_name} | Generated: {now}</p>\n        </div>\n        \n        <div class="summary-stats">\n            <div class="stat-card">\n                <div class="stat-title">Accuracy</div>\n                <div class="stat-value" id="accuracy-value">{accuracy:.1f}%</div>\n                <div class="stat-subtitle" id="accuracy-subtitle">{correct} correct out of {total_problems} problems</div>\n            </div>\n            <div class="stat-card">\n                <div class="stat-title">Total Duration</div>\n                <div class="stat-value" id="total-duration-value">{total_duration_s:.2f}s</div>\n                <div class="stat-subtitle" id="avg-duration-value">Average: {avg_duration_s:.2f}s per problem</div>\n            </div>\n            <div class="stat-card">\n                <div class="stat-title">Token Usage</div>\n                <div class="stat-value" id="total-tokens-value">{total_tokens:,}</div>\n                <div class="stat-subtitle" id="avg-tokens-value">Average: {avg_tokens:.1f} tokens per problem</div>\n            </div>\n            <div class="stat-card">\n                <div class="stat-title">Agent System</div>\n                <div class="stat-value">{agent_system}</div>\n                <div class="stat-subtitle">Benchmark: {benchmark_name}</div>\n            </div>\n        </div>\n        \n        <div class="charts">\n            <div class="chart-container">\n                <div class="chart-title">Performance Overview</div>\n                <canvas id="performanceChart"></canvas>\n            </div>\n            <div class="chart-container">\n                <div class="chart-title">Token Usage by Problem</div>\n                <canvas id="tokenChart"></canvas>\n            </div>\n        </div>\n        \n        <div class="problems-list" id="problems-list-container">\n            <h2>Problem Results</h2>\n            <div id="problemsList"></div>\n        </div>\n        \n        <div class="footer">\n            Generated by Multi-Agent System Benchmark Visualizer | {now}\n        </div>\n    </div>\n    \n    <script>\n    // Load the results data\n    const resultsData = {results_json};\n    const problemLinks = {problem_links_json};\n    \n    // Initialize charts when document is loaded\n    document.addEventListener(\'DOMContentLoaded\', () => {{\n        // Create performance overview chart\n        createPerformanceChart();\n        \n        // Create token usage chart\n        createTokenChart();\n        \n        // Create problem list\n        createProblemsList();\n        \n        // Initialize MathJax rendering\n        if (window.MathJax) {{\n            MathJax.typesetPromise();\n        }}\n    }});\n    \n    // Create performance overview chart\n    function createPerformanceChart() {{\n        const ctx = document.getElementById(\'performanceChart\').getContext(\'2d\');\n        \n        // Extract data for chart\n        const problemIds = resultsData.map(r => r.problem_id);\n        const durations = resultsData.map(r => r.duration_ms / 1000); // Convert to seconds\n        const correctness = resultsData.map(r => r.score === 1 ? \'Correct\' : \'Incorrect\');\n        \n        // Create colors array based on correctness\n        const colors = correctness.map(c => c === \'Correct\' ? \'#28a745\' : \'#dc3545\');\n        \n        new Chart(ctx, {{\n            type: \'bar\',\n            data: {{\n                labels: problemIds,\n                datasets: [{{\n                    label: \'Duration (seconds)\',\n                    data: durations,\n                    backgroundColor: colors,\n                    borderColor: colors.map(c => c === \'#28a745\' ? \'#218838\' : \'#c82333\'),\n                    borderWidth: 1\n                }}]\n            }},\n            options: {{\n                responsive: true,\n                maintainAspectRatio: false,\n                scales: {{\n                    y: {{\n                        beginAtZero: true,\n                        title: {{\n                            display: true,\n                            text: \'Duration (seconds)\'\n                        }}\n                    }},\n                    x: {{\n                        title: {{\n                            display: true,\n                            text: \'Problem ID\'\n                        }}\n                    }}\n                }},\n                plugins: {{\n                    tooltip: {{\n                        callbacks: {{\n                            afterLabel: function(context) {{\n                                const index = context.dataIndex;\n                                return correctness[index];\n                            }}\n                        }}\n                    }}\n                }}\n            }}\n        }});\n    }}\n    \n    // Create token usage chart\n    function createTokenChart() {{\n        const ctx = document.getElementById(\'tokenChart\').getContext(\'2d\');\n        \n        // Extract data for chart\n        const problemIds = resultsData.map(r => r.problem_id);\n        const tokenUsage = resultsData.map(r => r.llm_usage?.total_tokens || 0);\n        \n        new Chart(ctx, {{\n            type: \'bar\',\n            data: {{\n                labels: problemIds,\n                datasets: [{{\n                    label: \'Token Usage\',\n                    data: tokenUsage,\n                    backgroundColor: \'rgba(74, 110, 224, 0.7)\',\n                    borderColor: \'rgba(74, 110, 224, 1)\',\n                    borderWidth: 1\n                }}]\n            }},\n            options: {{\n                responsive: true,\n                maintainAspectRatio: false,\n                scales: {{\n                    y: {{\n                        beginAtZero: true,\n                        title: {{\n                            display: true,\n                            text: \'Token Count\'\n                        }}\n                    }},\n                    x: {{\n                        title: {{\n                            display: true,\n                            text: \'Problem ID\'\n                        }}\n                    }}\n                }}\n            }}\n        }});\n    }}\n    \n    // Create problems list\n    function createProblemsList() {{\n        const problemsListContainer = document.getElementById(\'problemsList\');\n        \n        resultsData.forEach(problem => {{\n            let statusText, cardClass, badgeClass;\n\n            if (problem.status === \'error\') {{\n                statusText = \'Errored\';\n                cardClass = \'errored\';\n                badgeClass = \'badge-errored\';\n            }} else if (problem.is_correct || problem.score > 0.5) {{\n                statusText = \'Passed\';\n                cardClass = \'correct\';\n                badgeClass = \'badge-success\';\n            }} else {{\n                statusText = \'Incorrect\';\n                cardClass = \'incorrect\';\n                badgeClass = \'badge-danger\';\n            }}\n\n            const problem_id = problem.problem_id || \'N/A\';\n            const duration = problem.duration_ms / 1000; // Convert to seconds\n            const tokenCount = problem.llm_usage?.total_tokens || 0;\n            \n            const problemCard = document.createElement(\'div\');\n            problemCard.className = `problem-card ${{cardClass}}`;\n            problemCard.id = `problem-${{problem_id}}`;\n            \n            // Create problem header\n            const problemHeader = document.createElement(\'div\');\n            problemHeader.className = \'problem-header\';\n            \n            const problemIdElem = document.createElement(\'div\');\n            problemIdElem.className = \'problem-id\';\n            problemIdElem.textContent = problem_id;\n            \n            const problemMetrics = document.createElement(\'div\');\n            problemMetrics.className = \'problem-metrics\';\n            \n            // Add badge for correctness\n            const correctnessBadge = document.createElement(\'span\');\n            correctnessBadge.className = `badge ${{badgeClass}}`;\n            correctnessBadge.textContent = statusText;\n            \n            // Add duration metric\n            const durationMetric = document.createElement(\'div\');\n            durationMetric.className = \'problem-metric\';\n            durationMetric.innerHTML = `<span>⏱️</span> ${{duration.toFixed(2)}}s`;\n            \n            // Add token metric\n            const tokenMetric = document.createElement(\'div\');\n            tokenMetric.className = \'problem-metric\';\n            tokenMetric.innerHTML = `<span>🔤</span> ${{tokenCount.toLocaleString()}} tokens`;\n            \n            problemMetrics.appendChild(correctnessBadge);\n            problemMetrics.appendChild(durationMetric);\n            problemMetrics.appendChild(tokenMetric);\n            \n            problemHeader.appendChild(problemIdElem);\n            problemHeader.appendChild(problemMetrics);\n            \n            // Create toggle button\n            const toggleButton = document.createElement(\'button\');\n            toggleButton.className = \'toggle-details\';\n            toggleButton.innerHTML = \'Show Details\';\n            toggleButton.onclick = () => {{\n                problemCard.classList.toggle(\'expanded\');\n                toggleButton.innerHTML = problemCard.classList.contains(\'expanded\') ? \'Hide Details\' : \'Show Details\';\n                \n                // Render LaTeX if details expanded\n                if (problemCard.classList.contains(\'expanded\') && window.MathJax) {{\n                    MathJax.typesetPromise([problemCard]);\n                }}\n            }};\n            \n            // Create problem content\n            const problemContent = document.createElement(\'div\');\n            problemContent.className = \'problem-details\';\n            \n            // Add problem statement\n            const problemStatement = document.createElement(\'div\');\n            problemStatement.className = \'problem-content\';\n            problemStatement.innerHTML = `<strong>Problem:</strong><div>${{problem.problem}}</div>`;\n            \n            // Add solution\n            const problemSolution = document.createElement(\'div\');\n            problemSolution.className = \'problem-solution\';\n            problemSolution.innerHTML = `<strong>Solution:</strong><div>${{problem.prediction}}</div>`;\n            \n            // Add expected answer\n            const expectedAnswer = document.createElement(\'div\');\n            expectedAnswer.className = \'problem-solution\';\n            expectedAnswer.innerHTML = `<strong>Expected:</strong><div>${{problem.expected}}</div>`;\n            \n            problemContent.appendChild(problemStatement);\n            problemContent.appendChild(problemSolution);\n            problemContent.appendChild(expectedAnswer);\n            \n            // Create problem footer with link to visualization if available\n            const problemFooter = document.createElement(\'div\');\n            problemFooter.className = \'problem-footer\';\n            \n            problemFooter.appendChild(toggleButton);\n            \n            // Add link to visualization if available\n            const vizLinkContainer = document.createElement(\'div\');\n            if (problemLinks[problem_id]) {{\n                const vizLink = document.createElement(\'a\');\n                vizLink.href = problemLinks[problem_id];\n                vizLink.className = \'view-details\';\n                vizLink.textContent = \'View Agent Interactions\';\n                vizLink.target = \'_blank\';\n                vizLinkContainer.appendChild(vizLink);\n            }}\n            problemFooter.appendChild(vizLinkContainer);\n            \n            // Assemble problem card\n            problemCard.appendChild(problemHeader);\n            problemCard.appendChild(problemFooter);\n            problemCard.appendChild(problemContent);\n            \n            problemsListContainer.appendChild(problemCard);\n        }});\n    }}\n    </script>\n</body>\n</html>\n'.format(title=title, agent_system=agent_system, benchmark_name=benchmark_name, now=now, accuracy=accuracy, correct=correct, total_problems=total_problems, total_duration_s=total_duration_ms / 1000, avg_duration_s=avg_duration_ms / 1000 if avg_duration_ms else 0, total_tokens=total_tokens, avg_tokens=avg_tokens, results_json=results_json, problem_links_json=problem_links_json)
        return html

    def visualize_benchmark(self, summary_file, results_file=None, visualizations_dir=None, output_file=None):
        """
        Generate HTML visualization from benchmark summary file with links to problem visualizations.

        Args:
            summary_file: Path to the benchmark summary JSON file
            results_file: Optional path to the benchmark results JSON file
            visualizations_dir: Optional directory containing problem visualizations
            output_file: Optional path to save the HTML output

        Returns:
            Path to the generated HTML file
        """
        with open(summary_file, 'r') as f:
            summary_data = json.load(f)
        results_data = []
        results_file_path = results_file or summary_data.get('results_file')
        if results_file_path and os.path.exists(results_file_path):
            with open(results_file_path, 'r') as f:
                data = json.load(f)
                results_data = data.get('results', [])
        problem_visualizations = {}
        if visualizations_dir:
            viz_dir = Path(visualizations_dir)
            agent_system = summary_data.get('agent_system', '')
            if agent_system and viz_dir.exists():
                for result in results_data:
                    problem_id = result.get('problem_id')
                    if problem_id:
                        viz_files = list(viz_dir.glob(f'viz_{agent_system}_{problem_id}_*.json'))
                        if viz_files:
                            viz_files.sort(key=lambda f: f.stat().st_mtime, reverse=True)
                            html_path = viz_files[0].with_suffix('.html')
                            if html_path.exists():
                                problem_visualizations[problem_id] = str(html_path)
                            else:
                                try:
                                    html_file = self.mas_visualizer.visualize(viz_files[0], open_browser=False)
                                    problem_visualizations[problem_id] = str(html_file)
                                except Exception as e:
                                    print(f'Error generating HTML for {problem_id}: {e}')
        html = self.generate_summary_html(summary_data=summary_data, results_data=results_data, problem_visualizations=problem_visualizations)
        if not output_file:
            timestamp = datetime.datetime.now().strftime('%Y%m%d_%H%M%S')
            benchmark_name = summary_data.get('benchmark', 'unknown')
            agent_system = summary_data.get('agent_system', 'unknown')
            output_file = self.output_dir / f'benchmark_{agent_system}_{benchmark_name}_{timestamp}.html'
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write(html)
        webbrowser.open(f'file://{os.path.abspath(output_file)}')
        return output_file